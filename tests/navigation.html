<!DOCTYPE html>
<html>
  <head>
    <title>Testing navigation tracking</title>
    <meta charset="utf8"/>
    <meta name="referrer" content="origin">
  </head>
  <body>
    <script src="./post_data.js"></src>
    <script>
     const navigateToNextPage = () => {
       let searchParams = new URLSearchParams(window.location.search);
       if (searchParams.get("mode") === "write") {
         searchParams.set("mode", "read");
         window.location.search = "?" + searchParams.toString();
       } else {
         const currentUrl = window.location.href;
         const desinationUrl = currentUrl.replace(
           "^https://arthuredelstein.net/browser-privacy/",
           "https://privacytests.org/");
         window.location.href = destinationUrl;
       }
     };

     addEventListener("message", async ({data}) => {
       console.log("navigation.html received message:", data);
       if (data["write window.name"]) {
         window.name = data["write window.name"];
       } else if (data["read window.name"]) {
         iframe.contentWindow.postMessage(window.name, "*");
         console.log("send window.name:", window.name);
       } else if (data["read document.referrer"]) {
         iframe.contentWindow.postMessage(document.referrer, "*");
         console.log("send document.referrer:", document.referrer);
       } else {
         document.body.setAttribute("data-test-results", JSON.stringify(data));
         await postData(data);
         navigateToNextPage();
       }
     }, false);
     let iframe = document.createElement("iframe");
     document.body.appendChild(iframe);
     iframe_root = (location.hostname === "localhost" ||
                    location.hostname === "127.0.0.1" ||
                    location.hostname === "")
                 ? "" : "https://arthuredelstein.net/browser-privacy";
     iframe.src = `${iframe_root}/tests/navigation_inner.html${window.location.search}`;
    </script>
  </body>
</html>
