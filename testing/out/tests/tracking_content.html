<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"/>
    <link rel="shortcut icon" href="#">
  </head>
  <body>
    <script id="testScript"></script>
    <script src="./post_data.js"></script>
    <script>
     const testUrl = async (url) => {
       let passed;
       const random = Math.random().toString().slice(2);
       try {
         const testElement = document.createElement(url.includes(".js") ? "script" : "img");
         document.body.appendChild(testElement);
         const resultPromise = new Promise((resolve, reject) => {
           testElement.addEventListener("load", e => resolve(e), { once: true});
           testElement.addEventListener("error", e => reject(e), { once: true});
         });
         const url2 = new URL(url);
         url2.searchParams.append("rand", random);
         testElement.src = url2.href;
         let result = await resultPromise;
         passed = false;
         console.log(url, result);
       } catch (err) {
         passed = true;
         console.log(url, err);
       }
       return passed;
     };

     const runTest = async () => {
       const response = await fetch("./trackers.json",   { headers: {'Accept': 'application/json' } });
       const tests = await response.json();
       let results = {};
       for (const {name, url} of tests) {
         const passed = await testUrl(url);
         const description = `Tests whether the browser blocks the page from loading the tracker at ${url}`;
         results[name] = { url, passed, description };
       }
       await postDataAndCarryOn(results, "trackers");
     };
     runTest();
    </script>
  </body>
</html>
